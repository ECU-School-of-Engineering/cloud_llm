SQL Queries

Tables:
1. conversations
session_id
turn_number
role
content
models_json
milestone
behaviour
escalation

2. feedback
id
session_id
payload_json
created_at

2.1 feedback_metadata
session_id
details
survey_type
created_at

2.2 feedback_messages
id
session_id
message_index
role
content
good
bad
comment
original_id
created_at

3. sessions
session_id
recipe_id
created_at
recipe_json



/////
Sessions > 15:
//////

SELECT 
    s.session_id,
    s.created_at
FROM sessions s
JOIN (
    SELECT session_id
    FROM conversations
    GROUP BY session_id
    HAVING MAX(turn_number) > 15
) c ON s.session_id = c.session_id
ORDER BY s.created_at;


//////
conversations + session
//////
SELECT
    c.session_id,
    c.turn_number,
    c.role,
    c.content,
    c.models_json,
    c.milestone,
    c.behaviour,
    c.escalation,
    s.recipe_id,
    s.created_at AS session_created_at,
    s.recipe_json
FROM conversations c
LEFT JOIN sessions s
    ON c.session_id = s.session_id
ORDER BY c.session_id, c.turn_number;
